name: Deploy Frontend to Heroku

on:
  push:
    branches:
      - prod
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch: # allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production-frontend
      url: https://flutevision-web-cd91d82764ea.herokuapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # need full history for subtree
      
      - name: Deploy frontend to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: flutevision-web
        run: |
          # configure git for heroku
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          
          # add heroku remote
          git remote add heroku-frontend https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git || true
          
          # push frontend subtree to heroku
          git push heroku-frontend `git subtree split --prefix frontend prod`:refs/heads/main --force
      
      - name: Check deployment status
        run: |
          echo "âœ… Frontend deployed successfully to https://flutevision-web-cd91d82764ea.herokuapp.com"

