---
import BaseLayout from '../layouts/BaseLayout.astro';
import CameraFeed from '../components/CameraFeed.astro';
import GameSettings from '../components/GameSettings.astro';

import '../css/game.css';
---

<BaseLayout selectedPage="game">
    
    <div id="game-container">
        <!-- Game Header Bar -->
        <div class="game-header">
            <div class="header-left">
                <button class="pause-btn" id="pauseBtn">
                    <span class="pause-icon">‚è∏</span> PAUSE
                </button>
                <button class="stop-btn" id="stopBtn">
                    <span class="stop-icon">‚èπ</span> STOP
                </button>
            </div>
            
            <div class="score-lives-container">
                <div class="hearts-container" id="heartsContainer">
                    <div class="heart filled">‚ù§Ô∏è</div>
                    <div class="heart filled">‚ù§Ô∏è</div>
                    <div class="heart filled">‚ù§Ô∏è</div>
                </div>
                <div class="score-container">
                    <div class="score-label">SCORE</div>
                    <div class="score-value" id="headerScore">0</div>
                </div>
            </div>
            
            <div class="header-right">
                <button class="game-settings-btn" id="gameSettingsBtn">
                    <span class="settings-icon">‚öôÔ∏è</span> SETTINGS
                </button>
            </div>
        </div>
        
        <!-- Game Main Area -->
        <div class="game-main">
            <!-- Camera feed overlay (small, inside game) -->
            <div class="camera-overlay">
                <div class="rec-indicator">REC</div>
                <CameraFeed videoId="video" />
                <div class="current-note" id="currentGesture">-</div>
            </div>
            
            <!-- Now Playing indicator -->
            <div class="now-playing">
                <div class="now-label">NOW:</div>
                <div class="now-note" id="targetGesture">-</div>
            </div>
            
            <!-- Game canvas -->
            <canvas id="gameCanvas"></canvas>
            
            <!-- Game over screen -->
            <div id="gameOverBackdrop" class="modal-backdrop hidden">
                <div id="gameOverScreen" class="game-over">
                    <h2>Game Over!</h2>
                    <p class="final-score">Score: <span id="finalScore">0</span></p>
                    <p class="final-combo">Max Combo: <span id="finalCombo">0</span></p>
                    <button id="restartBtn" class="game-btn">Play Again</button>
                </div>
            </div>
            
            <!-- Test complete screen -->
            <div id="testCompleteBackdrop" class="modal-backdrop hidden">
                <div id="testCompleteScreen" class="test-complete">
                    <h2>üéâ Test Complete! üéâ</h2>
                    <div class="test-name" id="completedTestName"></div>
                    <div class="test-stats">
                        <p class="final-score">Score: <span id="testFinalScore">0</span></p>
                        <p class="final-combo">Max Combo: <span id="testMaxCombo">0</span></p>
                        <p class="test-accuracy">Accuracy: <span id="testAccuracy">100%</span></p>
                        <p class="test-notes">Notes Hit: <span id="testNotesHit">0</span>/<span id="testTotalNotes">0</span></p>
                        <p class="test-duration">Duration: <span id="testDuration">0</span>s</p>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button id="testPlayAgainBtn" class="game-btn">Play Again</button>
                        <button id="testMenuBtn" class="game-btn secondary">Main Menu</button>
                    </div>
                </div>
            </div>
            
            <!-- Start screen -->
            <div id="startScreenBackdrop" class="modal-backdrop">
                <div id="startScreen" class="start-screen">
                    <h2>Ready to Play?</h2>
                    <p>Watch the NOW display and play the note to make your character jump!</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        <strong>Testing:</strong> Press <kbd style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px; border: 1px solid #ccc;">Space</kbd> to jump
                    </p>
                    <div id="status" class="status">Initializing...</div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button id="startBtn" class="game-btn" disabled>Start Game</button>
                        <button id="startScreenSettingsBtn" class="game-btn secondary">‚öôÔ∏è Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Settings Modal -->
    <GameSettings />
    
    <!-- Reuse existing camera/API infrastructure -->
    <script src="../js/camera.js"></script>
    
    <!-- Load in dependency order (bc modules depend on each other) -->
    
    <!-- Config layer -->
    <script src="../js/game/config/GameConstants.js"></script>
    <script src="../js/game/config/GameSettings.js"></script>
    
    <!-- Assets & Music -->
    <script src="../js/game/assets/AssetManager.js"></script>
    <script src="../js/game/music/MusicalTest.js"></script>
    
    <!-- Entities -->
    <script src="../js/game/entities/Player.js"></script>
    <script src="../js/game/entities/Obstacle.js"></script>
    
    <!-- Systems -->
    <script src="../js/game/systems/CollisionSystem.js"></script>
    <script src="../js/game/systems/RenderSystem.js"></script>
    
    <!-- Managers -->
    <script src="../js/game/managers/ScoreManager.js"></script>
    <script src="../js/game/managers/InputManager.js"></script>
    
    <!-- Core Engine -->
    <script src="../js/game/core/GameEngine.js"></script>
    
    <!-- UI Layer -->
    <script src="../js/game/ui/GameController.js"></script>
</BaseLayout>
